# Advanced Load Balancing with Health Checks
# Demonstrates passive health checks and failover

events {
    worker_connections 1024;
}

http {
    upstream api_gateway {
        # Least connections for better distribution
        least_conn;
        
        # Server definitions with health check parameters
        # max_fails: Number of failed attempts before marking server down
        # fail_timeout: Time server is considered down after max_fails
        # slow_start: Gradually increase traffic to recovering server (nginx plus only)
        
        server api-gateway:3000 max_fails=3 fail_timeout=30s weight=1;
        
        # Backup server (only used when all primary servers are down)
        # server backup-gateway:3000 backup;
        
        # To manually mark a server as down temporarily:
        # server api-gateway:3000 down;
        
        # Keepalive connections to backend
        keepalive 32;
    }

    server {
        listen 80;
        server_name localhost;

        # Enhanced logging for health monitoring
        log_format health '$remote_addr - [$time_local] "$request" '
                         '$status $upstream_addr $upstream_status '
                         '$request_time $upstream_response_time';
        
        access_log /var/log/nginx/access.log health;
        error_log /var/log/nginx/error.log warn;

        location / {
            proxy_pass http://api_gateway;
            
            # Connection and timeout settings
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Retry logic
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
            proxy_next_upstream_tries 3;
            proxy_next_upstream_timeout 10s;
            
            # Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Add upstream information to response headers (for debugging)
            add_header X-Upstream-Addr $upstream_addr always;
            add_header X-Upstream-Status $upstream_status always;
            add_header X-Upstream-Response-Time $upstream_response_time always;
            
            # Timeouts
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check endpoint
        location /nginx-health {
            access_log off;
            return 200 "Nginx is healthy\nUpstreams: Check /nginx-status\n";
            add_header Content-Type text/plain;
        }

        # Nginx status page (shows upstream status)
        location /nginx-status {
            stub_status;
            access_log off;
            # In production, restrict access:
            # allow 10.0.0.0/8;
            # deny all;
        }
    }
}

# ===================================================================
# HEALTH CHECK EXPLANATIONS
# ===================================================================
#
# 1. PASSIVE HEALTH CHECKS (Used here - Open Source Nginx)
#    - Monitors actual traffic
#    - Marks server down after max_fails consecutive failures
#    - No extra requests sent
#    - Reactive (waits for failures to happen)
#
# 2. ACTIVE HEALTH CHECKS (Nginx Plus only)
#    - Periodically sends health check requests
#    - Proactive (detects failures before user traffic hits them)
#    - Example:
#      health_check interval=5s fails=3 passes=2 uri=/health;
#
# 3. APPLICATION HEALTH ENDPOINT
#    - Already implemented: GET /api/health
#    - Returns 200 if service is healthy
#    - Should check:
#      * Database connectivity
#      * External service availability
#      * Resource availability (memory, disk)
#
# 4. KUBERNETES HEALTH CHECKS
#    - Liveness Probe: Is container alive? (restart if fails)
#    - Readiness Probe: Is container ready for traffic? (remove from service if fails)
#    - Startup Probe: Has container started? (for slow-starting apps)
#
# ===================================================================
