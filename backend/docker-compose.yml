version: "3.9"

services:
  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app-network
    depends_on:
      - api-gateway

  # API Gateway - Can be scaled with --scale api-gateway=N
  api-gateway:
    build: .
    command: node dist/apps/api-gateway/main.js
    # No port mapping - nginx handles routing
    expose:
      - "3000"
    networks:
      - app-network
    depends_on:
      - user-service
      - order-service
      - payment-service
    # Don't use container_name when scaling - Docker generates unique names

  user-service:
    build: .
    command: node dist/apps/user-service/main.js
    ports:
      - "3001:3001"
    networks:
      - app-network

  order-service:
    build: .
    command: node dist/apps/order-service/main.js
    ports:
      - "3002:3002"
    networks:
      - app-network

  payment-service:
    build: .
    command: node dist/apps/payment-service/main.js
    ports:
      - "3003:3003"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

